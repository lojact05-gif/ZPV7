name: ZaldoPrinter CI (Windows)

on:
  push:
    branches: [ "main", "master", "develop" ]
    paths:
      - "tools/ZaldoPrinter/**"
      - ".github/workflows/zaldoprinter-ci.yml"
  pull_request:
    branches: [ "main", "master", "develop" ]
    paths:
      - "tools/ZaldoPrinter/**"
      - ".github/workflows/zaldoprinter-ci.yml"
  workflow_dispatch:

env:
  DOTNET_VERSION: "8.0.x"
  CONFIGURATION: "Release"
  RUNTIME: "win-x64"
  # ✅ AJUSTE ESTE PATH para o csproj principal do serviço
  ZALDO_PRINTER_PROJECT: "tools/ZaldoPrinter/src/ZaldoPrinter.Service/ZaldoPrinter.Service.csproj"
  ARTIFACT_NAME: "ZaldoPrinter-win-x64"

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Restore
        run: dotnet restore "${{ env.ZALDO_PRINTER_PROJECT }}"

      - name: Build
        run: dotnet build "${{ env.ZALDO_PRINTER_PROJECT }}" -c ${{ env.CONFIGURATION }} --no-restore

      # Se tiver testes, ele roda. Se não tiver, não falha.
      - name: Test (if present)
        shell: pwsh
        run: |
          $sln = Get-ChildItem -Recurse -Filter *.sln | Select-Object -First 1
          if ($null -ne $sln) {
            dotnet test $sln.FullName -c $env:CONFIGURATION --no-build
          } else {
            Write-Host "No solution (.sln) found; skipping tests."
          }

      - name: Publish (self-contained)
        run: >
          dotnet publish "${{ env.ZALDO_PRINTER_PROJECT }}"
          -c ${{ env.CONFIGURATION }}
          -r ${{ env.RUNTIME }}
          --self-contained true
          /p:PublishSingleFile=true
          /p:IncludeNativeLibrariesForSelfExtract=true
          -o "out/${{ env.ARTIFACT_NAME }}"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.ARTIFACT_NAME }}
          path: out/${{ env.ARTIFACT_NAME }}/

  release:
    # Só cria release quando você taggear vX.Y.Z
    if: startsWith(github.ref, 'refs/tags/v')
    needs: build
    runs-on: windows-latest

    steps:
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ env.ARTIFACT_NAME }}
          path: "release/${{ env.ARTIFACT_NAME }}"

      - name: Zip artifact
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path dist | Out-Null
          Compress-Archive -Path "release/${{ env.ARTIFACT_NAME }}/*" -DestinationPath "dist/${{ env.ARTIFACT_NAME }}.zip" -Force

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: dist/${{ env.ARTIFACT_NAME }}.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
